{"componentChunkName":"component---src-components-blog-blog-template-js","path":"/blog/upload-files-to-aws-s3-using-pre-signed-post-data-and-a-lambda-function-7a9fb06d56c1","result":{"data":{"mdx":{"body":"var _excluded = [\"components\"];\nfunction _extends() { return _extends = Object.assign ? Object.assign.bind() : function (n) { for (var e = 1; e < arguments.length; e++) { var t = arguments[e]; for (var r in t) ({}).hasOwnProperty.call(t, r) && (n[r] = t[r]); } return n; }, _extends.apply(null, arguments); }\nfunction _objectWithoutProperties(e, t) { if (null == e) return {}; var o, r, i = _objectWithoutPropertiesLoose(e, t); if (Object.getOwnPropertySymbols) { var n = Object.getOwnPropertySymbols(e); for (r = 0; r < n.length; r++) o = n[r], -1 === t.indexOf(o) && {}.propertyIsEnumerable.call(e, o) && (i[o] = e[o]); } return i; }\nfunction _objectWithoutPropertiesLoose(r, e) { if (null == r) return {}; var t = {}; for (var n in r) if ({}.hasOwnProperty.call(r, n)) { if (-1 !== e.indexOf(n)) continue; t[n] = r[n]; } return t; }\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nvar _frontmatter = {\n  \"slug\": \"blog/upload-files-to-aws-s3-using-pre-signed-post-data-and-a-lambda-function-7a9fb06d56c1\",\n  \"title\": \"Upload files to AWS S3 using pre-signed POST data and a Lambda function\",\n  \"description\": \"Start your serverless journey by learning how to upload files directly to S3 using pre-signed POST data and a simple Lambda function.\",\n  \"tags\": [\"AWS\", \"S3\", \"Serverless\", \"File upload\", \"Lambda\"],\n  \"featureImage\": \"./assets/upload-files-to-aws-s3-using-pre-signed-post-data-and-a-lambda-function-7a9fb06d56c1/max-11520-077fY-3AU-ePf8vz-.jpeg\",\n  \"author\": \"adrian\",\n  \"date\": \"2019-04-11T00:00:00.000Z\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n    props = _objectWithoutProperties(_ref, _excluded);\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"When it comes to file uploads performed by client apps, \\u201Ctraditionally,\\u201D in a \\u201Cserverful\\u201D world, we might use the following approach:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"on the client side, the user submits a form and the upload begins\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"once the upload has been completed, we do all of the necessary work on the server, such as check the file type and size, sanitize the needed data, maybe do image optimizations, and then, finally, move the file to a preferred location, be it another storage server or maybe \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://aws.amazon.com/s3/\"\n  }, \"S3\"), \".\")), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"800px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/d02baa14294f53d8198d7e141e53c1bb/aa440/max-3000-1yg3TUvTi1P3m3NmI2XCEIQ.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"51%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVQoz42QTU7DMBCFc5ZeAokrcATWSIhttwXEASqW7NggxAYWXAEWCFZEKrSpBAUCRNQOOHX9F3s8KEn5C23haWRpNP40b16AP+TLh+fq8qutTb8pQEQAoJQqpRDRGEtIytKYc25yC1ok+5vPey2bkRL3dVgIEUURpdQ6IMM4Ta9oRhh7G42F4683W0tRc0EnfUSYAnvvtdbOucKFy7TuGS8nJsGOeucsPLUyNqpbMx/gbHkoVlkoqlyBU27+lUpVk+9aSa1kOfB/wlUugIjD4+1Bexke+3csbh2uHlzs1GKfAUNx/9Nus7PScNdnYdJdXG9sHK19oHPhKlWRDF7CE6/GMled+/CB3P7L9qc5h/P0Di2RPUu6QBw0AAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"max 3000 1yg3TUvTi1P3m3NmI2XCEIQ\",\n    \"title\": \"max 3000 1yg3TUvTi1P3m3NmI2XCEIQ\",\n    \"src\": \"/static/d02baa14294f53d8198d7e141e53c1bb/5a190/max-3000-1yg3TUvTi1P3m3NmI2XCEIQ.png\",\n    \"srcSet\": [\"/static/d02baa14294f53d8198d7e141e53c1bb/772e8/max-3000-1yg3TUvTi1P3m3NmI2XCEIQ.png 200w\", \"/static/d02baa14294f53d8198d7e141e53c1bb/e17e5/max-3000-1yg3TUvTi1P3m3NmI2XCEIQ.png 400w\", \"/static/d02baa14294f53d8198d7e141e53c1bb/5a190/max-3000-1yg3TUvTi1P3m3NmI2XCEIQ.png 800w\", \"/static/d02baa14294f53d8198d7e141e53c1bb/c1b63/max-3000-1yg3TUvTi1P3m3NmI2XCEIQ.png 1200w\", \"/static/d02baa14294f53d8198d7e141e53c1bb/aa440/max-3000-1yg3TUvTi1P3m3NmI2XCEIQ.png 1500w\"],\n    \"sizes\": \"(max-width: 800px) 100vw, 800px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"Although this is pretty straight forward, there are a few downsides:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Uploading files to a server can negatively impact its system resources (RAM and CPU), especially when dealing with larger files or image processing.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"If you are storing files on a separate storage server, you also don\\u2019t have unlimited disk space, which means that, as the file base grows, you\\u2019ll need to do upgrades.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Oh, yeah, and did I mention backups?\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Security \\u2014 there are never enough preventive steps that you can implement in this department.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"We constantly need to monitor these servers in order to avoid downtime and provide the best possible user experience.\")), mdx(\"p\", null, \"Woah! \\uD83D\\uDE30\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"453px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/ca045952e3bb3b7555389caaa921ebae/2108e/max-906-1lR1eIK7oRxdGehhrTFieOw.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"99.50000000000001%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEv0lEQVQ4ywXB21eSBwAA8K+OZw9b12km8oEaEJAiU26KAmogoEgSgoYJghduiYDIzRtX+bgqgsKHKGJHKaWsVq61XM3aw552zk4v7Xmnv2O/H3BU2s9sJuFMCt7agDfXcpn1x/lkLh3Op0Pp1bkMZC0kF8rbnue7gWcF/6vD9TfHO0fFzSKcKObiQDjgjkbD+48fn56efv78Z3GvEIV8v7379ePH89Nf3r4/Ozv/9Pn4sFg+Pnr96uRwd/3pUfnJ0+Pd3Z2dTAxYsOlsFqPXuxKBAvFoMJMMbUYXZw3TfL5ApdJM6ef1M27NlFmnt6pUE6Flay4FRUPeQn7rcD8LOB1W7ZRaO612WPWQz5bwm3cz0VLpCZyDDw4Ozn7/uJ3fO3nx0uMNCfsVg/eVO3n40x/v37x+eXJSBoKrEbPFplIpNUq5SffQNCldcRgzmxt6o2XOvpTN5rMZOJFIWizz/SK5RKocVRrfvfvw9eu/5+fngMcbcC945u0LVptr3u50O2whj2NYKkPV0+gdYh5XUnr6dnvvZXIDDgYgiWR4QCyXShWmGWv52QvANme3WO12x5LHH4kns1twMV84GBhUYm/TJXJdLPUkX/pw9PNfhwfPx8fGxQPSgYGhLnZPHYhKpTYAu90xa5ozm20O5+IqtJbJl9LbJQqNewtHcfngo9O/rWa/fmrO54+JhCIut1coGOxm9yTj0W/f/gM8yy6n3el2Li0vefz+UCoNx9dzGEwTDk8LJErLvi3Z4OgjnSkSWZPLRtqZnVQqk8XkLLqX/vnyBYAgyOsN+jxBnzfk94fj65nwGnwbT7525YbG4F3ypscU6rGRh49MFu5dbiORRCSQyM0tDfU4l2sFSEVWw8FgJBQPRTf94XQwlvbGc8QmOgAAJDJj1h5Qqyc57K76ugYcBnvt6vWrl6+gkWjETbCXfw/IRbwJKLieLmT2X0HrO4uBqGE+gEDiKy5W1CBAFod3/er12hr0tSs/Xvr+h6qq2qpKxM3qmzcqq5ub6QAcW41Hk4Xy+53yWSi5vQIl7vYpvqu4dOHChYsXK0Tie11d3Y0kVmVlPQqNJza2tbSw7zS1V1XWXr5cBeQ34lubeZ3Z39kj62DzR8YNIKqp+gZIIJA4XUKd3mIyWbu6xfQ2HofFa2slzxun3I5Fl8OzFksCe8VD8f3xemwngdhOaqJLhiZ0Bqfe6NDPuE0Wj8FoM2p1YoFQ0CscFPKNk5rYKpRNJffyub3dPBCIwAgkmULtplI6ZLLRaDzrdK9MaLR9IumDYbnigWJ6WqudUEkGxQrFqGpsdMY4ZZqZtFoe+ZadQP89JQFPbSFTBL19eqNdP7swqZ2RSmWigQGZVCIU8Pk83rBc1tcnYDBoXC5POnRfrVYaDVqXwwqIxCoMCi3iC1VKtUSqkEhG+kWSbq6gu4dHobS001s62lppdAqL08liddIYDAaDyuP2jMqHJsdHgIlxDa2VwmFzuNzeTiaTQW3F4/F3GolYDIaAx7UxWpntdBKJSKNRGhsbsVgMHo/DYOrQIILyEwHoYbM5LCaRQARBVE11NQpVi0QiEIgaEASRSBAJgigUiLnVUF+Hbmiow2IxONwtMqmpmXSH2kr+H5MY1RrGqASKAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"max 906 1lR1eIK7oRxdGehhrTFieOw\",\n    \"title\": \"max 906 1lR1eIK7oRxdGehhrTFieOw\",\n    \"src\": \"/static/ca045952e3bb3b7555389caaa921ebae/2108e/max-906-1lR1eIK7oRxdGehhrTFieOw.png\",\n    \"srcSet\": [\"/static/ca045952e3bb3b7555389caaa921ebae/772e8/max-906-1lR1eIK7oRxdGehhrTFieOw.png 200w\", \"/static/ca045952e3bb3b7555389caaa921ebae/e17e5/max-906-1lR1eIK7oRxdGehhrTFieOw.png 400w\", \"/static/ca045952e3bb3b7555389caaa921ebae/2108e/max-906-1lR1eIK7oRxdGehhrTFieOw.png 453w\"],\n    \"sizes\": \"(max-width: 453px) 100vw, 453px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"But, luckily, there\\u2019s an easier and better way to perform file uploads! By using \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"pre-signed POST data\"), \", rather than our own servers, S3 enables us to perform uploads directly to it, in a controlled, performant, and very safe manner. \\uD83D\\uDE80\"), mdx(\"p\", null, \"You might be asking yourself: \\u201CWhat is pre-signed POST data and how does it all work together.\\u201D Well, sit back and relax, because, in this short post, we\\u2019ll cover everything you need to know to get you started.\"), mdx(\"p\", null, \"For demonstration purposes, we\\u2019ll also create a simple app for which we\\u2019ll use a little bit of React on the frontend and a simple Lambda function (in conjunction with API gateway) on the backend.\"), mdx(\"p\", null, \"Let\\u2019s go!\"), mdx(\"h2\", {\n    \"id\": \"how-does-it-work\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, \"How Does It Work?\", mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#how-does-it-work\",\n    \"aria-label\": \"how does it work permalink\",\n    \"className\": \"heading-link-anchor after\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\",\n    \"fill\": \"none\",\n    \"viewBox\": \"0 0 24 24\",\n    \"stroke\": \"currentColor\"\n  }, \"\\n                              \", mdx(\"path\", {\n    parentName: \"svg\",\n    \"strokeLineCap\": \"round\",\n    \"strokeLineJoin\": \"round\",\n    \"strokeWidth\": \"2\",\n    \"d\": \"M7 20l4-16m2 16l4-16M6 9h14M4 15h14\"\n  }), \"\\n                            \"))), mdx(\"p\", null, \"On a high level, it is basically a two-step process:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"The client app makes an HTTP request to an API endpoint of your choice (1), which responds (2) with an upload URL and pre-signed POST data (more information about this soon). Note that this request does not contain the actual file that needs to be uploaded, but it can contain additional data if needed. For example, you might want to include the file name if for some reason you need it on the backend side. You are free to send anything you need, but this is certainly not a requirement. For the API endpoint, as mentioned, we\\u2019re going to utilize a simple Lambda function.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Once it receives the response, the client app makes a \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"multipart/form-data\"), \" POST request (3), this time directly to S3. This one contains received pre-signed POST data, along with the file that is to be uploaded. Finally, S3 responds with the 204 OK response code if the upload was successful or with \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://docs.aws.amazon.com/AmazonS3/latest/API/ErrorResponses.html\"\n  }, \"an appropriate error response code\"), \" if something went wrong.\")), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"800px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/525bef121580e302880821822af5b51c/7f15f/max-3060-1K5yybcjSoP_jMZUlZ_n2lw.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"58.50000000000001%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABI0lEQVQoz5WSvUrEQBCA80BylY21nY9hr4Vi4wPYXWVjoQh2FhaiaKVwVxzCiWAjhhPEHMmFJLtxN9n87cyshIgYVEy+bof95m/XMn9C5j+s3z2iTE6MKZsjFgpkRLoi1CAZ5mlLJiLXdYMgIKI8z6VUnjtXSkkhtDHh+XC2s5I83ij7zt5Y8o63awXhUwYAx3F83yfCRCY8GrN0niihkhSNCS/37a1lcX+lZtPnzYF3stuSG6TMIsaJCCECU5LBJq4LlXGfdImgufeWCd50a31fj+CTxeIljgWh7rLGVmWNTJRuGPrvbGw6YP1IDAAQx6wo86xSFZT9ngqpHvX26Xr9aO10evAV6SZjffXi4Wx1b3A4GvaTG1SROuGryOLeP6wjH/81sm2dHI0jAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"max 3060 1K5yybcjSoP jMZUlZ n2lw\",\n    \"title\": \"max 3060 1K5yybcjSoP jMZUlZ n2lw\",\n    \"src\": \"/static/525bef121580e302880821822af5b51c/5a190/max-3060-1K5yybcjSoP_jMZUlZ_n2lw.png\",\n    \"srcSet\": [\"/static/525bef121580e302880821822af5b51c/772e8/max-3060-1K5yybcjSoP_jMZUlZ_n2lw.png 200w\", \"/static/525bef121580e302880821822af5b51c/e17e5/max-3060-1K5yybcjSoP_jMZUlZ_n2lw.png 400w\", \"/static/525bef121580e302880821822af5b51c/5a190/max-3060-1K5yybcjSoP_jMZUlZ_n2lw.png 800w\", \"/static/525bef121580e302880821822af5b51c/c1b63/max-3060-1K5yybcjSoP_jMZUlZ_n2lw.png 1200w\", \"/static/525bef121580e302880821822af5b51c/7f15f/max-3060-1K5yybcjSoP_jMZUlZ_n2lw.png 1530w\"],\n    \"sizes\": \"(max-width: 800px) 100vw, 800px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"Alright, now that we\\u2019ve gotten that out of the way, you might still be thinking what pre-signed POST data is and what information it contains.\"), mdx(\"p\", null, \"It is basically a set of fields and values, which, first of all, contains information about the actual file that\\u2019s to be uploaded, such as the S3 key and destination bucket. Although not required, it\\u2019s also possible to set additional fields that further describe the file, for example, its content type or allowed file size.\"), mdx(\"p\", null, \"It also contains information about the file upload request itself, for example, security token, policy, and a signature (hence the name \\u201Cpre-signed\\u201D). With these values, the S3 determines if the received file upload request is valid and, even more importantly, allowed. Otherwise, anybody could just upload any file to it as they liked. These values are generated for you by the AWS SDK.\"), mdx(\"p\", null, \"To check it out, let\\u2019s take a look at a sample result of the\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"createPresignedPost\"), \" method call, which is part of the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://aws.amazon.com/sdk-for-node-js/\"\n  }, \"Node.js AWS SDK\"), \" and which we\\u2019ll later use in the implementation section of this post. The pre-signed POST data is contained in the \\u201Cfields\\u201D key:\"), mdx(\"deckgo-highlight-code\", {\n    \"highlight-lines\": \"undefined\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"{\\n    \\\"url\\\": \\\"https://s3.us-east-2.amazonaws.com/webiny-cloud-z1\\\",\\n    \\\"fields\\\": {\\n        \\\"key\\\": \\\"uploads/1jt1ya02x_sample.jpeg\\\",\\n        \\\"bucket\\\": \\\"webiny-cloud-z1\\\",\\n        \\\"X-Amz-Algorithm\\\": \\\"AWS4-HMAC-SHA256\\\",\\n        \\\"X-Amz-Credential\\\": \\\"A..../us-east-2/s3/aws4_request\\\",\\n        \\\"X-Amz-Date\\\": \\\"20190309T203725Z\\\",\\n        \\\"X-Amz-Security-Token\\\": \\\"FQoGZXIvYXdzEMb//////////...i9kOQF\\\",\\n        \\\"Policy\\\": \\\"eyJleHBpcmF0a...UYifV19\\\",\\n        \\\"X-Amz-Signature\\\": \\\"05ed426704d359c1c68b1....6caf2f3492e\\\"\\n    }\\n}\"), \"\\n        \"), mdx(\"p\", null, \"As developers, we don\\u2019t really need to concern ourselves too much with the values of some of these fields (once we\\u2019re sure the user is actually authorized to request this information). It\\u2019s important to note that all of the fields and values must be included when doing the actual upload, otherwise the S3 will respond with an error.\"), mdx(\"p\", null, \"Now that we know the basics, we\\u2019re ready to move onto the actual implementation. We\\u2019ll start with the client side, after which we\\u2019ll prepare our S3 bucket and finally create our Lambda function.\"), mdx(\"h2\", {\n    \"id\": \"client\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, \"Client\", mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#client\",\n    \"aria-label\": \"client permalink\",\n    \"className\": \"heading-link-anchor after\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\",\n    \"fill\": \"none\",\n    \"viewBox\": \"0 0 24 24\",\n    \"stroke\": \"currentColor\"\n  }, \"\\n                              \", mdx(\"path\", {\n    parentName: \"svg\",\n    \"strokeLineCap\": \"round\",\n    \"strokeLineJoin\": \"round\",\n    \"strokeWidth\": \"2\",\n    \"d\": \"M7 20l4-16m2 16l4-16M6 9h14M4 15h14\"\n  }), \"\\n                            \"))), mdx(\"p\", null, \"As we\\u2019ve mentioned at the beginning of this post, we\\u2019re going to use React on the client side, so what we have here is a simple React component that renders a button, which enables the user to select any type of file from his local system. Once selected, we immediately start the file upload process.\"), mdx(\"p\", null, \"Let\\u2019s take a look:\"), mdx(\"deckgo-highlight-code\", {\n    \"language\": \"javascript\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"import React from \\\"react\\\";\\nimport Files from \\\"react-butterfiles\\\";\\n/**\\n * Retrieve pre-signed POST data from a dedicated API endpoint.\\n * @param selectedFile\\n * @returns {Promise<any>}\\n */\\nconst getPresignedPostData = selectedFile => {\\n  return new Promise(resolve => {\\n    const xhr = new XMLHttpRequest();\\n    \\n    // Set the proper URL here.\\n    const url = \\\"https://mysite.com/api/files\\\";\\n    \\n    xhr.open(\\\"POST\\\", url, true);\\n    xhr.setRequestHeader(\\\"Content-Type\\\", \\\"application/json\\\");\\n    xhr.send(\\n      JSON.stringify({\\n        name: selectedFile.name,\\n        type: selectedFile.type\\n      })\\n    );\\n    xhr.onload = function() {\\n      resolve(JSON.parse(this.responseText));\\n    };\\n  });\\n};\\n/**\\n * Upload file to S3 with previously received pre-signed POST data.\\n * @param presignedPostData\\n * @param file\\n * @returns {Promise<any>}\\n */\\nconst uploadFileToS3 = (presignedPostData, file) => {\\n  return new Promise((resolve, reject) => {\\n    const formData = new FormData();\\n    Object.keys(presignedPostData.fields).forEach(key => {\\n      formData.append(key, presignedPostData.fields[key]);\\n    });\\n    // Actual file has to be appended last.\\n    formData.append(\\\"file\\\", file);\\n    const xhr = new XMLHttpRequest();\\n    xhr.open(\\\"POST\\\", presignedPostData.url, true);\\n    xhr.send(formData);\\n    xhr.onload = function() {\\n      this.status === 204 ? resolve() : reject(this.responseText);\\n    };\\n  });\\n};\\n/**\\n * Component renders a simple \\\"Select file...\\\" button which opens a file browser.\\n * Once a valid file has been selected, the upload process will start.\\n * @returns {*}\\n * @constructor\\n */\\nconst FileUploadButton = () => (\\n  <Files\\n    onSuccess={async ([selectedFile]) => {\\n      // Step 1 - get pre-signed POST data.\\n      const { data: presignedPostData } = await getPresignedPostData(selectedFile);\\n      // Step 2 - upload the file to S3.\\n      try {\\n        const { file } = selectedFile.src;\\n        await uploadFileToS3(presignedPostData, file);\\n        console.log(\\\"File was successfully uploaded!\\\");\\n      } catch (e) {\\n        console.log(\\\"An error occurred!\\\", e.message);\\n      }\\n    }}\\n  >\\n    {({ browseFiles }) => <button onClick={browseFiles}>Select file...</button>}\\n  </Files>\\n);\"), \"\\n        \"), mdx(\"p\", null, \"For an easier file selection and cleaner code, we\\u2019ve utilized a small package called \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/doitadrian/react-butterfiles\"\n  }, \"react-butterfiles\"), \". The author of the package is actually me, so if you have any questions or suggestions, feel free to let me know! \\uD83D\\uDE09\"), mdx(\"p\", null, \"Other than that, there aren\\u2019t any additional dependencies in the code. We didn\\u2019t even bother to use a 3rd party HTTP client (for example \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/axios/axios\"\n  }, \"axios\"), \") since we were able to achieve everything with the built-in XMLHttpRequest API.\"), mdx(\"p\", null, \"Note that we\\u2019ve used \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developer.mozilla.org/en-US/docs/Web/API/FormData\"\n  }, \"FormData\"), \" for assembling the request body of the second S3 request. Besides appending all of the fields contained in the pre-signed POST data, also make sure that the actual file is appended as the last field. If you do that before, S3 will return an error, so watch for that one.\"), mdx(\"h2\", {\n    \"id\": \"s3-bucket\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, \"S3 Bucket\", mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#s3-bucket\",\n    \"aria-label\": \"s3 bucket permalink\",\n    \"className\": \"heading-link-anchor after\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\",\n    \"fill\": \"none\",\n    \"viewBox\": \"0 0 24 24\",\n    \"stroke\": \"currentColor\"\n  }, \"\\n                              \", mdx(\"path\", {\n    parentName: \"svg\",\n    \"strokeLineCap\": \"round\",\n    \"strokeLineJoin\": \"round\",\n    \"strokeWidth\": \"2\",\n    \"d\": \"M7 20l4-16m2 16l4-16M6 9h14M4 15h14\"\n  }), \"\\n                            \"))), mdx(\"p\", null, \"Let\\u2019s create an S3 bucket, which will store all of our files. In case you don\\u2019t know how to create it, the simplest way to do this would be via the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://s3.console.aws.amazon.com/s3\"\n  }, \"S3 Management Console\"), \".\"), mdx(\"p\", null, \"Once created, we must adjust the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://s/Web/HTTP/CORS\"\n  }, \"CORS\"), \" configuration for the bucket. By default, every bucket accepts only GET requests from another domain, which means our file upload attempts (POST requests) would be declined:\"), mdx(\"deckgo-highlight-code\", {\n    \"highlight-lines\": \"undefined\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"Access to XMLHttpRequest at 'https://s3.amazonaws.com/presigned-post-test' from origin 'http://localhost:3001' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.\"), \"\\n        \"), mdx(\"p\", null, \"To fix that, simply open your bucket in the S3 Management Console and select the \\u201CPermissions\\u201D tab, where you should be able to see the \\u201CCORS configuration\\u201D button.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"800px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/2b6ca797770e2c0627000534c948a02b/076ca/max-1828-19pQIYln66ecbml6c0ZCF1g.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"60%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB3ElEQVQoz32NW2sTQRSA9+f64D8Q8d0H0beYlCS1GFsxl7UhIQ8SaRGheIFSVJR6SZvsZfYys+fMzO7O7h7ZpJZewI+PGWYO34wVoY5AKyVZGLIoioXI8yzLUmOM1CqI4zCOWOT7IU8QjcmzLF1P8wTA2hlNmy/t9nDa3B1u7Q639obtwbhrzxq9/pt3R6YoOWdRuCCiD8cnjd6ga886o+nTF4Ovp7+s5/a0PZhsT+ad/rjbH3df7Xfs2fb0baM3mL//SER+yH+uAmno4NOX1p69Mzt8Npm39kbfTn9bWJAqCXLKK8qJZEmyoKoiU1GgyqKsxt+TO68Xd/cXDw8XRLwiICppjRVEwmGx44deELssCuIkErBRoDLG+LI4dtWJp3+EaVWV1T/q+ODo83Ll/FmcLVeO6zHPr3U83/OZ4BwAijwjk5JJqzzVeuMF1r1HjTAMg4AxxrgQkCQAkAiBCIgIAEIkHJADCsDkOtaDJy1ATNNUCLFcrRzHcV3XcRzP84QQCKi0Rs9Lzs8gYFJKdQXr/uNmzHkcx0EQcCEu3gTY7IgolcIoTHwP4kgiyivUsQBAKUFKlaY3lFpLrVWWySyr1/Xx0jpO1tmNwTWVqn+8dX8Z6//FWqNSt+O/ZouKyfJcemMAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"max 1828 19pQIYln66ecbml6c0ZCF1g\",\n    \"title\": \"max 1828 19pQIYln66ecbml6c0ZCF1g\",\n    \"src\": \"/static/2b6ca797770e2c0627000534c948a02b/5a190/max-1828-19pQIYln66ecbml6c0ZCF1g.png\",\n    \"srcSet\": [\"/static/2b6ca797770e2c0627000534c948a02b/772e8/max-1828-19pQIYln66ecbml6c0ZCF1g.png 200w\", \"/static/2b6ca797770e2c0627000534c948a02b/e17e5/max-1828-19pQIYln66ecbml6c0ZCF1g.png 400w\", \"/static/2b6ca797770e2c0627000534c948a02b/5a190/max-1828-19pQIYln66ecbml6c0ZCF1g.png 800w\", \"/static/2b6ca797770e2c0627000534c948a02b/076ca/max-1828-19pQIYln66ecbml6c0ZCF1g.png 914w\"],\n    \"sizes\": \"(max-width: 800px) 100vw, 800px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"Looking at the default policy in the above screenshot, we just need to append the following rule:\"), mdx(\"deckgo-highlight-code\", {\n    \"highlight-lines\": \"undefined\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"<AllowedMethod>POST</AllowedMethod>\"), \"\\n        \"), mdx(\"p\", null, \"The complete policy would then be the following:\"), mdx(\"deckgo-highlight-code\", {\n    \"highlight-lines\": \"undefined\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"<CORSConfiguration>\\n    <CORSRule>\\n        <AllowedOrigin>*</AllowedOrigin>\\n        <AllowedMethod>GET</AllowedMethod>\\n        <AllowedMethod>POST</AllowedMethod>\\n        <MaxAgeSeconds>3000</MaxAgeSeconds>\\n        <AllowedHeader>Authorization</AllowedHeader>\\n    </CORSRule>\\n</CORSConfiguration>\"), \"\\n        \"), mdx(\"p\", null, \"Alright, let\\u2019s move to the last piece of the puzzle and that\\u2019s the Lambda function.\"), mdx(\"h2\", {\n    \"id\": \"lambda\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, \"Lambda\", mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#lambda\",\n    \"aria-label\": \"lambda permalink\",\n    \"className\": \"heading-link-anchor after\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\",\n    \"fill\": \"none\",\n    \"viewBox\": \"0 0 24 24\",\n    \"stroke\": \"currentColor\"\n  }, \"\\n                              \", mdx(\"path\", {\n    parentName: \"svg\",\n    \"strokeLineCap\": \"round\",\n    \"strokeLineJoin\": \"round\",\n    \"strokeWidth\": \"2\",\n    \"d\": \"M7 20l4-16m2 16l4-16M6 9h14M4 15h14\"\n  }), \"\\n                            \"))), mdx(\"p\", null, \"Since it is a bit out of the scope of this post, I\\u2019ll assume you already know how to deploy a Lambda function and expose it via the API gateway, using the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://serverless.com/\"\n  }, \"Serverless framework\"), \". The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"serverless.yaml\"), \" file I used for this little project can be found \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://gist.github.com/doitadrian/80cf3182ba1b60181a461eb7f2b6acca\"\n  }, \"here\"), \".\"), mdx(\"p\", null, \"To generate pre-signed POST data, we will utilize the AWS SDK, which is \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html\"\n  }, \"by default\"), \" available in every Lambda function. This is great, but we must be aware that it can only execute actions that were allowed by the role that is currently assigned to the Lambda function. This is important because, in our case, if the role didn\\u2019t have the permission for creating objects in our S3 bucket, upon uploading the file from the client, S3 would respond with the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Access Denied\"), \" error:\"), mdx(\"deckgo-highlight-code\", {\n    \"highlight-lines\": \"undefined\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<Error><Code>AccessDenied</Code><Message>Access Denied</Message><RequestId>DA6A3371B16D0E39</RequestId><HostId>DMetGYguMQ+e+HXmNShxcG0/lMg8keg4kj/YqnGOi3Ax60=</HostId></Error>\"), \"\\n        \"), mdx(\"p\", null, \"So, before continuing, make sure your Lambda function has an adequate role. For this, we can create a new role, and attach the following policy to it:\"), mdx(\"deckgo-highlight-code\", {\n    \"highlight-lines\": \"undefined\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"{\\n    \\\"Version\\\": \\\"2012-10-17\\\",\\n    \\\"Statement\\\": [\\n        {\\n            \\\"Sid\\\": \\\"VisualEditor0\\\",\\n            \\\"Effect\\\": \\\"Allow\\\",\\n            \\\"Action\\\": \\\"s3:PutObject\\\",\\n            \\\"Resource\\\": \\\"arn:aws:s3:::presigned-post-data/*\\\"\\n        }\\n    ]\\n}\"), \"\\n        \"), mdx(\"p\", null, \"A quick tip here: for security reasons, when creating roles and defining permissions, make sure to follow the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://en.wikipedia.org/wiki/Principle_of_least_privilege\"\n  }, \"principle of least privilege\"), \", or in other words, assign only permissions that are actually needed by the function. No more, no less. In our case, we specifically allowed \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"s3:PutObject\"), \" action on the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"presigned-post-data\"), \" bucket. Avoid assigning default \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AmazonS3FullAccess\"), \" at all costs.\"), mdx(\"p\", null, \"Alright, if your role is ready, let\\u2019s take a look at our Lambda function:\"), mdx(\"deckgo-highlight-code\", {\n    \"language\": \"javascript\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"const S3 = require(\\\"aws-sdk/clients/s3\\\");\\nconst uniqid = require(\\\"uniqid\\\");\\nconst mime = require(\\\"mime\\\");\\n/**\\n * Use AWS SDK to create pre-signed POST data.\\n * We also put a file size limit (100B - 10MB).\\n * @param key\\n * @param contentType\\n * @returns {Promise<object>}\\n */\\nconst createPresignedPost = ({ key, contentType }) => {\\n  const s3 = new S3();\\n  const params = {\\n    Expires: 60,\\n    Bucket: \\\"presigned-post-data\\\",\\n    Conditions: [[\\\"content-length-range\\\", 100, 10000000]], // 100Byte - 10MB\\n    Fields: {\\n      \\\"Content-Type\\\": contentType,\\n      key\\n    }\\n  };\\n  return new Promise(async (resolve, reject) => {\\n    s3.createPresignedPost(params, (err, data) => {\\n      if (err) {\\n        reject(err);\\n        return;\\n      }\\n      resolve(data);\\n    });\\n  });\\n};\\n/**\\n * We need to respond with adequate CORS headers.\\n * @type {{\\\"Access-Control-Allow-Origin\\\": string, \\\"Access-Control-Allow-Credentials\\\": boolean}}\\n */\\nconst headers = {\\n  \\\"Access-Control-Allow-Origin\\\": \\\"*\\\",\\n  \\\"Access-Control-Allow-Credentials\\\": true\\n};\\nmodule.exports.getPresignedPostData = async ({ body }) => {\\n  try {\\n    const { name } = JSON.parse(body);\\n    const presignedPostData = await createPresignedPost({\\n      key: `${uniqid()}_${name}`,\\n      contentType: mime.getType(name)\\n    });\\n    return {\\n      statusCode: 200,\\n      headers,\\n      body: JSON.stringify({\\n        error: false,\\n        data: presignedPostData,\\n        message: null\\n      })\\n    };\\n  } catch (e) {\\n    return {\\n      statusCode: 500,\\n      headers,\\n      body: JSON.stringify({\\n        error: true,\\n        data: null,\\n        message: e.message\\n      })\\n    };\\n  }\\n};\"), \"\\n        \"), mdx(\"p\", null, \"Besides passing the basic\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"key\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Content-Type\"), \" fields (line 18), we also appended the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"content-length-range\"), \" condition (line 17), which limits the file size to a value from 100B to 10MB. This is very important, because without the condition, users would basically be able to upload a 1TB file if they decided to do it.\"), mdx(\"p\", null, \"The provided values for the condition are in bytes. Also note that there are \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-HTTPPOSTConstructPolicy.html\"\n  }, \"other\"), \" file conditions you can apply if needed.\"), mdx(\"p\", null, \"One final note regarding the \\u201Cnaive\\u201D \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ContentType\"), \" detection you might\\u2019ve noticed (line 49). Because the HTTP request that will trigger this Lambda function doesn\\u2019t contain the actual file, it\\u2019s impossible to check if the detected content type is actually valid. Although this will suffice for this post, in a real-world application you would do additional checks once the file has been uploaded. This can be done either via an additional Lambda function that gets triggered once the file has been uploaded, or you could design custom file URLs, which point to a Lambda function and not to the actual file. This way, you can make necessary inspections (ideally only once is enough) before sending the file back to the client.\"), mdx(\"h2\", {\n    \"id\": \"lets-try-it-out\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, \"Let\\u2019s Try It Out!\", mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#lets-try-it-out\",\n    \"aria-label\": \"lets try it out permalink\",\n    \"className\": \"heading-link-anchor after\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\",\n    \"fill\": \"none\",\n    \"viewBox\": \"0 0 24 24\",\n    \"stroke\": \"currentColor\"\n  }, \"\\n                              \", mdx(\"path\", {\n    parentName: \"svg\",\n    \"strokeLineCap\": \"round\",\n    \"strokeLineJoin\": \"round\",\n    \"strokeWidth\": \"2\",\n    \"d\": \"M7 20l4-16m2 16l4-16M6 9h14M4 15h14\"\n  }), \"\\n                            \"))), mdx(\"p\", null, \"If you\\u2019ve managed to execute all of the steps correctly, everything should be working fine. To try it out, let\\u2019s first try to upload files that don\\u2019t comply with the file size condition. So, if the file is smaller than 100B, we should receive the following error message:\"), mdx(\"deckgo-highlight-code\", {\n    \"highlight-lines\": \"undefined\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"POST https://s3.us-east-2.amazonaws.com/webiny-cloud-z1 400 (Bad Request)\\n\\nUncaught (in promise) <?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<Error><Code>EntityTooSmall</Code><Message>Your proposed upload is smaller than the minimum allowed size</Message><ProposedSize>19449</ProposedSize><MinSizeAllowed>100000</MinSizeAllowed><RequestId>AB7CE8CC00BAA851</RequestId><HostId>mua824oABTuCfxYr04fintcP2zN7Bsw1V+jgdc8Y5ZESYN9/QL8454lm4++C/gYqzS3iN/ZTGBE=</HostId></Error>\"), \"\\n        \"), mdx(\"p\", null, \"On the other hand, if it\\u2019s larger than 10MB, we should also receive the following:\"), mdx(\"deckgo-highlight-code\", {\n    \"highlight-lines\": \"undefined\"\n  }, \"\\n          \", mdx(\"code\", {\n    parentName: \"deckgo-highlight-code\",\n    \"slot\": \"code\"\n  }, \"POST https://s3.us-east-2.amazonaws.com/webiny-cloud-z1 400 (Bad Request)\\n\\nUncaught (in promise) <?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<Error><Code>EntityTooLarge</Code><Message>Your proposed upload exceeds the maximum allowed size</Message><ProposedSize>10003917</ProposedSize><MaxSizeAllowed>10000000</MaxSizeAllowed><RequestId>50BB30B533520F40</RequestId><HostId>j7BSBJ8Egt6G4ifqUZXeOG4AmLYN1xWkM4/YGwzurL4ENIkyuU5Ql4FbIkDtsgzcXkRciVMhA64=</HostId></Error>\"), \"\\n        \"), mdx(\"p\", null, \"Finally, if we tried to upload a file that\\u2019s in the allowed range, we should receive the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"204 No content\"), \" HTTP response and we should be able to see the file in our S3 bucket.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"800px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/1f5b2ed7b98070525d714f21d7071cc2/8d68c/max-2468-13Fw2bkGbM43OMYgpG-TPgg.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"69%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAACa0lEQVQoz6WT3U9ScRjH+UtaW+si30EslASkNwmYi1pWM9/K5Vpmutl0yTt4OG/igcNRXLNWuWEuORBDDqhAI7rRBA6kXGis2rysrcs859d03ZR55ffqe/PZ99nzfB8BOIIEHM8DAGKbxZFgyLzImMIR0yJjWFoxxpP6lfieiS4ZluOmSNQUjlgWmeHA24VsDgDA8bxgl+MAAEQiedJiFyO4EMaEECLpHxR33Glo7z59t7fu8ZOz9/tEVkgIY2IEP2G26UNhAMAux/2Bp1JpMTre5CJl5KTCbNOI61XaK+rb3ZquHlnfgEp0prGrRzY1rSRIEYLbmdhf8GTqvQjBFQQpdVNSGLtpMNa6KaGbqsQnWnEn8uLlPSchgTGFm6pxYLZI9AAM43KXRwrBwx5qfsF/HYKHvNPYs+fLsRg95wv5fDccSMOEWwgfAstcHqXVPkq40ukPmdXV7WKxWCjMzs4mk+/WP65dhVEpQR4C74/d6KbKRo0zvrlvpdLnUinH7unnj++vg8Eqg/kc5a1xoP+H5QQpI0iJ96nGSbwKBJlEggmHt7e23jDMjM93bcxxeDKMyV2eRsx5uaNb0feoQW+qt9jbEazNgdQ/6G9uvSU3WeV7CzuQ7E2l69BxJTnZhE9o2jq1LTrdRbVOealFcUF9XqVTaZvbOpvGYKVnqhbBx/451fhK4rjRWg2hFRB6CnOWwVi5xV45OCR6OFClN5fboDLUWeHAqiH0mMEyEgwBAH5xnIDfr2dhZ2d+PRNgWTrH0tkcnWP9bN7/aWNhY9OfL9Bsns6ydJYNsPn59czal68AAJ7nBUd5jN8HRz1B/NJeeAAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"max 2468 13Fw2bkGbM43OMYgpG TPgg\",\n    \"title\": \"max 2468 13Fw2bkGbM43OMYgpG TPgg\",\n    \"src\": \"/static/1f5b2ed7b98070525d714f21d7071cc2/5a190/max-2468-13Fw2bkGbM43OMYgpG-TPgg.png\",\n    \"srcSet\": [\"/static/1f5b2ed7b98070525d714f21d7071cc2/772e8/max-2468-13Fw2bkGbM43OMYgpG-TPgg.png 200w\", \"/static/1f5b2ed7b98070525d714f21d7071cc2/e17e5/max-2468-13Fw2bkGbM43OMYgpG-TPgg.png 400w\", \"/static/1f5b2ed7b98070525d714f21d7071cc2/5a190/max-2468-13Fw2bkGbM43OMYgpG-TPgg.png 800w\", \"/static/1f5b2ed7b98070525d714f21d7071cc2/c1b63/max-2468-13Fw2bkGbM43OMYgpG-TPgg.png 1200w\", \"/static/1f5b2ed7b98070525d714f21d7071cc2/8d68c/max-2468-13Fw2bkGbM43OMYgpG-TPgg.png 1234w\"],\n    \"sizes\": \"(max-width: 800px) 100vw, 800px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"h2\", {\n    \"id\": \"other-approaches-to-uploading-files\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, \"Other Approaches to Uploading Files\", mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#other-approaches-to-uploading-files\",\n    \"aria-label\": \"other approaches to uploading files permalink\",\n    \"className\": \"heading-link-anchor after\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\",\n    \"fill\": \"none\",\n    \"viewBox\": \"0 0 24 24\",\n    \"stroke\": \"currentColor\"\n  }, \"\\n                              \", mdx(\"path\", {\n    parentName: \"svg\",\n    \"strokeLineCap\": \"round\",\n    \"strokeLineJoin\": \"round\",\n    \"strokeWidth\": \"2\",\n    \"d\": \"M7 20l4-16m2 16l4-16M6 9h14M4 15h14\"\n  }), \"\\n                            \"))), mdx(\"p\", null, \"This method of uploading files is certainly not the only or the \\u201Cright\\u201D one. S3 actually offers a few ways to accomplish the same thing. You choose the one that mostly aligns with your needs and environment.\"), mdx(\"p\", null, \"For example, \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://aws.amazon.com/amplify/\"\n  }, \"AWS Amplify client framework\"), \" might be a good solution for you, but if you\\u2019re not utilizing other AWS services like Cognito or AppSync, you don\\u2019t really need to use it. The method we\\u2019ve shown here, on the client side, consists of two simple HTTP POST requests for which we certainly didn\\u2019t need to use the whole framework, nor any other package for that matter. Always strive to make your client app build as light as possible.\"), mdx(\"p\", null, \"You might\\u2019ve also heard about the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getSignedUrl-property\"\n  }, \"pre-signed URL approach\"), \". If you were wondering what is the difference between the two, on a high level, it is similar to the pre-signed POST data approach, but it is less \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getSignedUrl-property\"\n  }, \"customizable\"), \":\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Note:\"), \" Not all operation parameters are supported when using pre-signed URLs. Certain parameters, such as \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SSECustomerKey\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ACL\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Expires\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ContentLength\"), \", or \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Tagging\"), \" must be provided as headers when sending a request. If you are using pre-signed URLs to upload from a browser and need to use these fields, see \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#createPresignedPost-property\"\n  }, \"createPresignedPost()\"), \".\")), mdx(\"p\", null, \"One notable feature that it lacks is specifying the minimum and maximum file size, which in this post we\\u2019ve accomplished with the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"content-length-range\"), \"condition. Since this is a must-have if you ask me, the approach we\\u2019ve covered in this post would definitely be my go-to choice.\"), mdx(\"h2\", {\n    \"id\": \"additional-steps\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, \"Additional Steps\", mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#additional-steps\",\n    \"aria-label\": \"additional steps permalink\",\n    \"className\": \"heading-link-anchor after\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\",\n    \"fill\": \"none\",\n    \"viewBox\": \"0 0 24 24\",\n    \"stroke\": \"currentColor\"\n  }, \"\\n                              \", mdx(\"path\", {\n    parentName: \"svg\",\n    \"strokeLineCap\": \"round\",\n    \"strokeLineJoin\": \"round\",\n    \"strokeWidth\": \"2\",\n    \"d\": \"M7 20l4-16m2 16l4-16M6 9h14M4 15h14\"\n  }), \"\\n                            \"))), mdx(\"p\", null, \"Although the solution we\\u2019ve built does the job pretty well, there is always room for improvement. Once you hit production, you will certainly want to add the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://aws.amazon.com/cloudfront/\"\n  }, \"CloudFront CDN\"), \" layer, so that your files are distributed faster all over the world.\"), mdx(\"p\", null, \"If you\\u2019ll be working with image or video files, you will also want to optimize them, because it can save you a lot of bytes (and money of course), thus making your app work much faster.\"), mdx(\"h2\", {\n    \"id\": \"conclusion\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, \"Conclusion\", mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#conclusion\",\n    \"aria-label\": \"conclusion permalink\",\n    \"className\": \"heading-link-anchor after\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"xmlns\": \"http://www.w3.org/2000/svg\",\n    \"fill\": \"none\",\n    \"viewBox\": \"0 0 24 24\",\n    \"stroke\": \"currentColor\"\n  }, \"\\n                              \", mdx(\"path\", {\n    parentName: \"svg\",\n    \"strokeLineCap\": \"round\",\n    \"strokeLineJoin\": \"round\",\n    \"strokeWidth\": \"2\",\n    \"d\": \"M7 20l4-16m2 16l4-16M6 9h14M4 15h14\"\n  }), \"\\n                            \"))), mdx(\"p\", null, \"Serverless is a really hot topic these days and it\\u2019s not surprising since so much work is abstracted away from us, making our lives easier as software developers. When comparing to \\u201Ctraditional serverful\\u201D architectures, both S3 and Lambda that we\\u2019ve used in this post basically require no or very little system maintenance and monitoring. This gives us more time to focus on what really matters, and ultimately that is the actual product we\\u2019re creating.\"), mdx(\"p\", null, \"Thanks for sticking until the very end of this article. Feel free to let me know if you have any questions or corrections, I would be glad to check them out!\"), mdx(\"hr\", null), mdx(\"p\", null, \"Thanks for reading! My name is Adrian and I work as a full stack developer at \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.hoola.ai\"\n  }, \"Hoola AI\"), \". In my spare time, I like to write about my experiences with some of the modern frontend and backend web development tools, hoping it might help other developers. If you have any questions, comments or just wanna say hi, feel free to reach out to me via \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://www.twitter.com/doitadrian\"\n  }, \"Twitter\"), \".\"));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"author":"adrian","slug":"blog/upload-files-to-aws-s3-using-pre-signed-post-data-and-a-lambda-function-7a9fb06d56c1","title":"Upload files to AWS S3 using pre-signed POST data and a Lambda function","description":"Start your serverless journey by learning how to upload files directly to S3 using pre-signed POST data and a simple Lambda function.","tags":["AWS","S3","Serverless","File upload","Lambda"],"date":"April 11, 2019","featureImage":{"publicURL":"/static/a2f4d577a0f0f6f7304abc9989fd4262/max-11520-077fY-3AU-ePf8vz-.jpeg","childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwT/xAAVAQEBAAAAAAAAAAAAAAAAAAACAf/aAAwDAQACEAMQAAABzOgKRAp//8QAGRAAAwADAAAAAAAAAAAAAAAAAAECAyEx/9oACAEBAAEFAsaRVs6S9DP/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAEBAQAAAAAAAAAAAAAAAAAQEQH/2gAIAQEABj8Cusf/xAAcEAEBAAEFAQAAAAAAAAAAAAABABEhMUGBkaH/2gAIAQEAAT8hACPUzRfGXe5lrPH2WG//2gAMAwEAAgADAAAAEHg//8QAFhEAAwAAAAAAAAAAAAAAAAAAEBEh/9oACAEDAQE/EHB//8QAFREBAQAAAAAAAAAAAAAAAAAAEEH/2gAIAQIBAT8Qp//EAB0QAAICAgMBAAAAAAAAAAAAAAERACExQVFhgaH/2gAIAQEAAT8QaUnRIH3mX2QtEvr7CFbOMuBpIRd7XENjsmdoQgqup//Z","aspectRatio":1.5037593984962405,"src":"/static/a2f4d577a0f0f6f7304abc9989fd4262/14b42/max-11520-077fY-3AU-ePf8vz-.jpg","srcSet":"/static/a2f4d577a0f0f6f7304abc9989fd4262/f836f/max-11520-077fY-3AU-ePf8vz-.jpg 200w,\n/static/a2f4d577a0f0f6f7304abc9989fd4262/2244e/max-11520-077fY-3AU-ePf8vz-.jpg 400w,\n/static/a2f4d577a0f0f6f7304abc9989fd4262/14b42/max-11520-077fY-3AU-ePf8vz-.jpg 800w,\n/static/a2f4d577a0f0f6f7304abc9989fd4262/47498/max-11520-077fY-3AU-ePf8vz-.jpg 1200w,\n/static/a2f4d577a0f0f6f7304abc9989fd4262/0e329/max-11520-077fY-3AU-ePf8vz-.jpg 1600w,\n/static/a2f4d577a0f0f6f7304abc9989fd4262/d2452/max-11520-077fY-3AU-ePf8vz-.jpg 4000w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{"slug":"blog/upload-files-to-aws-s3-using-pre-signed-post-data-and-a-lambda-function-7a9fb06d56c1"}},"staticQueryHashes":["144257237"]}